# Codebase Analysis & Current Functionality Report
**Date:** February 16, 2026
**Generated by:** Antigravity (AI Assistant)

## 1. Executive Summary

The codebase represents a mature, feature-rich web application built with **Next.js 16 (App Router)**. It serves as a companion platform for the "Bharatvarsh" novel, integrating immersive storytelling features (interactive timeline, lore explorer) with advanced AI capabilities (RAG-based conversational agent "Bhoomi") and a budding community platform (Forum).

The architecture follows a strict "Screaming Architecture" pattern, organising code by domain feature rather than technical role. This ensures scalability and maintainability as new modules (like the Forum) are added.

## 2. Technology Stack

### Core Framework
- **Frontend/Fullstack**: Next.js 16.1.1 (React 19)
- **Language**: TypeScript 5 (Strict Mode)
- **Styling**: Tailwind CSS v4 + Radix UI Primitives + Framer Motion (for complex animations)

### Backend & Data
- **Database**: PostgreSQL (Cloud SQL)
- **ORM**: Prisma 6.19.2
- **Vector Search**: `pgvector` extension for RAG (Bhoomi AI)
- **Authentication**: NextAuth.js v5 (Beta) with Prisma Adapter
- **AI/ML**: Google Cloud Vertex AI (Gemini Models)

### Infrastructure & Services
- **Hosting**: Google Cloud Run (containerised via Docker)
- **Email**: Resend
- **CMS/Content**: Static JSON for narrative content (`src/content`), Database for User Generated Content (Forum)

## 3. Architecture Overview

The project adheres to the definitions in `docs/ARCHITECTURE.md`, but implementation has advanced beyond the "Future Plans" section.

### Directory Structure (`src/`)

| Directory | Purpose | Key Modules |
| :--- | :--- | :--- |
| **`app/`** | Route Shell | `api/` (Endpoints), `(routes)/` (Page wrappers) |
| **`features/`** | **Primary Logic** | `home`, `novel`, `lore`, `timeline`, `newsletter`, **`forum`** (Active), `auth`, `admin` |
| **`shared/`** | Reusable UI/Hooks | `ui/` (Design System), `layout/` (Nav/Footer) |
| **`content/`** | Data Abstraction | `loaders.ts` (Unified API for JSON/Static data) |
| **`server/`** | Backend Integrations | `email.ts`, `db.ts` (Prisma instance) |
| **`lib/`** | Utilities | `utils.ts`, `metadata.ts` |

### Key Architectural Patterns
1.  **Feature Isolation**: A `forum` feature is completely self-contained in `src/features/forum` with its own components, hooks, and types. It does not leak logic into `shared`.
2.  **Server-Only Security**: Backend modules (like email sending or DB access) are guarded with `import 'server-only'` to prevent client-side bundling.
3.  **Data Abstraction**: The `content/loaders.ts` pattern decouples UI components from the data source (file system vs database), easing migration.

## 4. Feature Analysis

### A. Bhoomi AI (Conversational Agent)
- **Status**: **Production Ready / Active Iteration**
- **Functionality**: RAG (Retrieval Augmented Generation) powered chatbot.
- **Data Source**: Ingests narrative content (`.txt`, `.docx`) into a `VectorStore` table using Vertex AI embeddings.
- **Persona**: "Historic Research Scholar from the Mesh Era".
- **Tracking**: Logs sessions and messages (`AiChatSession`, `AiChatMessage`) for analytics.
- **Recent Updates**: Added auth gating (5-prompt limit for anonymous users).

### B. The Forum (Community)
- **Status**: **Beta / In Development**
- **Functionality**: Standard thread-based discussion board.
- **Components**: Topics, Threads, Posts, Reactions, Reporting system.
- **Moderation**: 
    - AI Pre-screening (Gemini Flash).
    - Human Moderation Dashboard (Reports, Bans).
    - Soft-delete strategy for content (preserving audit trails).
- **Backend**: Fully relational schema in Postgres (`Thread`, `Post`, `User`, `Reaction`).

### C. Immersive Narrative Features
- **Timeline**: Horizontal and vertical scrolling timeline of events. Uses complex scroll calculations.
- **Lore Explorer**: Card-based interface for characters, locations, and factions.
- **Novel Page**: Purchase/Pre-order interfaces.

### D. Admin Dashboard
- **Status**: **Active**
- **Functionality**: 
    - User management.
    - Event tracking (page views, interactions).
    - AI Session oversight.

## 5. Data Model (Prisma Schema Scope)

The database schema (`prisma/schema.prisma`) is comprehensive and currently supports:

1.  **Identity**: Users, Accounts (OAuth), Sessions, VerificationTokens.
2.  **Engagement**: `Event` (Analytic outcomes), `Lead` (Newsletter signups).
3.  **Content (Forum)**: `Topic` -> `Thread` -> `Post` hierarchy, plus `Reaction` and `Report`.
4.  **AI Knowledge**: `VectorStore` (embeddings + metadata).
5.  **AI Logs**: `AiChatSession` -> `AiChatMessage`.
6.  **Audit**: `AuditLog`, `ModerationAction`.

## 6. Current Observations & Recommendations

1.  **Documentation Sync**: The `ARCHITECTURE.md` refers to "Future Forum Readiness". Since `src/features/forum` exists and the schema is deployed, the Forum is now an **active feature**. Documentation should be updated to reflect this transition from "planned" to "implemented".
2.  **Test Coverage**: While `load-tests` exist, ensure unit/integration tests for critical paths (especially Forum permissions and AI gating) are robust given the complexity.
3.  **Performance**: With the addition of DB-backed sessions (Auth.js) and RAG, monitor Cloud SQL connection limits and latency. The `Adsr-012` decision (Public IP for Cloud SQL) might need review as traffic scales.

---
*End of Analysis*
